---
- name: Deploy
  hosts: all
  tasks:
  - name: Include default environment variables
    ansible.builtin.include_vars:
      file: default_env.yml
      name: env_variables

  - name: Include environment variables
    ansible.builtin.include_vars:
      file: "{{ inventory_hostname }}/env.yml"
      name: env_variables
      hash_behaviour: merge

  - name: Include default secret environment variables
    ansible.builtin.include_vars:
      file: default_secret_env.yml
      name: secret_env_variables

  - name: Include secret environment variables
    ansible.builtin.include_vars:
      file: "{{ inventory_hostname }}/secret_env.yml"
      name: secret_env_variables
      hash_behaviour: merge

  - name: Ensure data directory
    become: yes
    ansible.builtin.file:
      path: "{{ data_dir }}"
      state: directory
      owner: "{{ ansible_user }}"
      group: "{{ ansible_user }}"
      mode: '755'

  - name: Ensure data directories
    become: yes
    ansible.builtin.file:
      path: "{{ item }}"
      state: directory
      owner: "{{ ansible_user }}"
      group: "{{ ansible_user }}"
      mode: '755'
    loop:
      - "{{ backend_data_dir }}"
      - "{{ files_dir }}"
      - "{{ db_dir }}"
      - "{{ apache_sites_dir }}"
      - "{{ omutskrift_print_dir }}"
      - "{{ omutskrift_printed_dir }}"

  - name: Ensure bestall apache configuration
    become: true
    ansible.builtin.template:
      src: 'bestall-apache.conf.j2'
      dest: "{{ [apache_sites_dir, 'default.conf'] | path_join }}"

  - name: Ensure backend data directory locations.json
    ansible.builtin.copy:
      src: ../config/data/locations.json
      dest: "{{ backend_data_dir }}"

  - name: Ensure print bestall .htpasswd
    ansible.builtin.copy:
      content: "{{ apache_htpasswd }}"
      dest: "{{ [data_dir, '.htpasswd'] | path_join }}"

  - name: Deploy app
    include_role:
      name: ub-ansible-deploy
